# Аналитика — как всё устроено и куда подключать бэк

Тут расписано всё по аналитике: какие экраны есть, откуда берутся данные, как считаются метрики и что нужно отдавать с бэка чтобы всё заработало. Сейчас весь фронт живёт на моках — твоя задача подменить их на реальный API.

---

## Маршруты — что где лежит

У нас три основных экрана:

**Аналитика сети** — `/analytics`
Файл: `app/analytics/page.tsx`
Это главный дашборд. Тут лидерборд партнёров, все графики по сети, воронки, фильтры. Данные получает через `getAnalyticsData(period)`.

**Аналитика меня** — `/analytics/me`
Файл: `app/analytics/me/page.tsx`
Определяет текущего юзера через `getCurrentUserId()` и рендерит его персональную аналитику. Можно редактировать план.

**Аналитика партнёра** — `/analytics/partners/[id]`
Файл: `app/analytics/partners/[id]/page.tsx`
То же самое что "аналитика меня", только чужая карточка — план нельзя редактировать, только смотреть.

Оба персональных экрана используют один компонент — `components/analytics-network/person-analytics-page.tsx`. Там есть проп `mode: "me" | "partner"` который определяет что можно делать.

---

## Откуда сейчас берутся данные

Весь data-layer сейчас в одном файле: `lib/mock/analytics-network.ts`

Оттуда экспортируются четыре функции:

| Функция | Что делает |
|---|---|
| `getAnalyticsData(period)` | Возвращает всю аналитику по сети (лидерборд, графики, KPI, воронки) |
| `getPersonAnalyticsData(personId, period)` | Возвращает персональную аналитику конкретного человека |
| `getCurrentUserId()` | Отдаёт id текущего юзера (сейчас захардкожен) |
| `getPeriodDateRange(period)` | Считает границы периода (start/end даты) |

Типы данных описаны в `types/analytics.ts`. Там главные интерфейсы:
- `AnalyticsData` — для сети
- `PersonAnalyticsData` — для карточки человека
- `PartnerRow` — строка партнёра в лидерборде
- `FunnelBoard` — воронка с колонками и стадиями
- `DynamicKpi` — метрики которые меняются от периода (звонки, чаты, лиды, сделки)
- `StaticKpi` — константы (уровень, рефералы)

Когда будешь делать API — ответ должен соответствовать этим типам. Фронт ожидает ровно эту структуру.

---

## Периоды

Тип: `AnalyticsPeriod = "week" | "month" | "allTime"`

Как считаются границы (в `getPeriodDateRange`):
- **week** — от понедельника до воскресенья текущей календарной недели (не "последние 7 дней", а именно Пн-Вс)
- **month** — с 1-го числа по последний день текущего месяца
- **allTime** — с 2020-01-01 по сегодня

На что обратить внимание: фронт ожидает данные на КАЖДЫЙ день внутри периода. Если период — неделя из 7 дней, то массив `activityTimeseries` должен содержать 7 точек. Будущие дни (которые ещё не наступили) — отдавай нулями, фронт сам их пометит серым.

---

## Что рисуется на экране сети (`/analytics`)

Компоненты на странице (слева направо, сверху вниз):

1. **Статические KPI** — уровень, линия, партнёры. Не зависят от периода.
   `components/analytics-network/static-kpi-cards.tsx`

2. **Динамические KPI** — лиды, активности, сделки, движение воронки. Зависят от периода.
   `components/analytics-network/dynamic-kpi-cards.tsx`

3. **Лидерборд** — таблица партнёров с поиском и фильтрами.
   `components/analytics-network/leaderboard-table.tsx`
   Фильтры применяются так: сначала поиск по имени → потом "только онлайн" → потом "не активные 7 дней".
   Клик по строке — переход в `/analytics/partners/{id}`.

4. **Графики лидов и активности** — линейные чарты по дням.
   `components/analytics-network/leads-chart.tsx`
   `components/analytics-network/activity-chart.tsx`

5. **Календарь активности** — месячная сетка с цветовой разметкой.
   `components/analytics-network/activity-calendar-card.tsx`
   При выбранном периоде `week` — внутри месяца рамкой выделяется нужная неделя.
   Клик по ячейке открывает попап с разбивкой: сколько звонков, чатов, рассылок.
   Цвета: 0 активностей — красный, 1-4 — жёлтый, 5+ — зелёный.

6. **Состав активности** — пирог по каналам + метрики.
   `components/analytics-network/activity-composition.tsx`

7. **Конверсии** — горизонтальные бары по этапам воронки.
   `components/analytics-network/conversion-overview-chart.tsx`

8. **Распределение партнёров** — пирог: активные / средние / пассивные.
   `components/analytics-network/partners-activity-distribution.tsx`

9. **Канбан воронок** — колонки со стадиями.
   `components/analytics-network/funnel-kanban.tsx`

---

## Что рисуется на персональном экране (`/analytics/me` и `/analytics/partners/[id]`)

Всё в `components/analytics-network/person-analytics-page.tsx`:

- Шапка с аватаром, переключатель периода
- Карточка "Личные итоги" (суммарные цифры за период)
- Динамические KPI
- Состав активности (тот же пирог)
- Цитата дня
- Профиль активности (стрик, среднее за день, лучший день, активность по дням недели)
- Блок эффективности (конверсии по воронке)
- План/факт + статусы лидов
- Графики лидов и активности
- Канбан воронок

---

## Формулы — тут внимательно

Эти формулы должны совпадать между фронтом и бэком. Если расходятся — юзер видит разные цифры в разных местах и теряет доверие.

**Всего активностей:**
```
totalTouches = callClicks + chatOpens + selectionsCreated
```
Это звонки + чаты + рассылки. Используется везде.

**Сделки:**
Берутся из воронки `sales`. Считаются кумулятивно от стадии `"Заключен договор"` и правее (все стадии после неё тоже считаются как сделки). Функция `getStageCumulativeCount()`.

**Конверсии воронки:**
```
conversion = countНаСтадии / countНаПредыдущейСтадии * 100
```
Считаются кумулятивно — то есть "на стадии" означает "на этой стадии + все кто прошёл дальше". Используется в трёх местах: диаграмма конверсий, блок эффективности в персональной аналитике, дропдаун в канбане.

**Движение по воронке:**
```
funnelMoves = round(addedLeads * 1.6 + selectionsCreated * 0.5)
```
Синтетический показатель — насколько лиды двигаются вправо по воронке.

**КПА (коэффициент полезной активности):**
```
touchToDeal = deals / totalTouches * 100
```
Градации: >= 12% сильный, >= 6% средний, < 6% низкий.

**Средняя нагрузка на колонку:**
```
averageColumnLoad = totalLeads / columnsCount
```

---

## План/факт

Файл: `components/analytics-network/personal-analytics-insights.tsx`

Сейчас планы хранятся в `localStorage` под ключом `analytics.personal.planTargets.v1`. Структура: отдельные цели для `week` и `month`, поля `leads`, `contacts` (это активности), `deals`.

Когда подключишь бэк — это надо будет перенести в API. Юзер ставит себе цели, они сохраняются, потом фронт сравнивает факт с планом.

---

## Цитата дня

Файлы: `public/quotes.json` + `lib/mock/daily-quotes.ts`

Цитата выбирается один раз в сутки и не меняется до следующего дня. У каждого юзера своя последовательность (по `userKey`). Формат JSON:

```json
[{ "id": "unique-id", "text": "Текст цитаты", "author": "Автор" }]
```

---

## Как подключить реальный API

Тебе нужно сделать три эндпоинта:

**1. `GET /api/analytics?period=week|month|allTime`**
Возвращает `AnalyticsData` — всё для экрана сети.

**2. `GET /api/analytics/person/{id}?period=week|month|allTime`**
Возвращает `PersonAnalyticsData` — всё для карточки человека.

**3. Любой способ получить id текущего юзера**
Сейчас это `getCurrentUserId()`, замени на свою авторизацию.

Потом в `lib/mock/analytics-network.ts` подменяешь моковые функции на fetch к API. Структура ответа должна совпадать с типами из `types/analytics.ts` — фронт парсит ровно эти поля.

---

## Навигация и экспорты

Все аналитические компоненты экспортируются через `components/analytics-network/index.ts` — это barrel export, не трогай без необходимости.

Ссылки между экранами ("Аналитика сети" / "Аналитика меня") живут в `components/app-header.tsx`.

---

## Что обычно ломается

Вот типичные косяки при интеграции — если заранее про них знать, сэкономишь кучу времени:

- **Неделя считается по-разному.** Фронт ждёт календарную неделю Пн-Вс. Если бэк отдаёт "последние 7 дней" — цифры поплывут.

- **Сделки считаются не от той стадии.** Обязательно от `"Заключен договор"` и правее. Если считать только тех кто именно на этой стадии (без прошедших дальше) — конверсии будут занижены.

- **`activityTotal` не бьётся.** Должен быть ровно `callClicks + chatOpens + selectionsCreated`. Если бэк считает по-другому — пирог и цифры в карточках разъедутся.

- **Не хватает точек в таймсериях.** Если период — неделя, в массиве должно быть 7 элементов (по одному на каждый день). Если 5 — календарь и графики сломаются.

- **`onlineDaysLast7` не совпадает с фильтром.** Фильтр "Не активные 7 дней" проверяет `partner.onlineDaysLast7 === 0`. Если бэк считает это поле иначе — фильтр будет врать.

---

## Перед тем как катить

Пройдись руками по этим сценариям:
- На `/analytics` — поищи партнёра, потыкай фильтры, перейди в профиль
- На `/analytics/me` — поредактируй план, обнови страницу, проверь что сохранилось
- На `/analytics/partners/{id}` — убедись что план нельзя редактировать
- В календаре — проверь что будущие дни серые и не кликабельные
- В воронках — что цвета правильные (синий = отказ, зелёный = в работе, жёлтый = успех)
- Конверсии — что цифры в диаграмме совпадают с дропдауном в канбане

Если где-то цифры расходятся — скорее всего формула на бэке отличается от той что в разделе "Формулы" выше. Начинай оттуда.

---

Порядок работы если добавляешь новое поле: сначала тип в `types/analytics.ts`, потом поддержка в API, потом в компонент. Не наоборот.

# Интеграция аналитики: полный гайд для нового бэкенд-разработчика

## Для кого этот документ
Документ для человека, который впервые видит проект и не знает текущую реализацию.

Цель:
- быстро понять, какие данные ждёт UI;
- не ошибиться в таймингах и расчётах;
- подключить реальный API без визуальных и числовых расхождений.

---

## Что есть в продукте
В аналитике есть 3 основных экрана:
- сеть: `app/analytics/page.tsx`
- "моя аналитика": `app/analytics/me/page.tsx`
- карточка партнёра: `app/analytics/partners/[id]/page.tsx`

Типы данных (контракт):
- `types/analytics.ts`

Текущая референс-логика (мок, но это источник истины для формул):
- `lib/mock/analytics-network.ts`

---

## Коротко про архитектуру данных
Сейчас UI читает данные из мок-функций:
- `getAnalyticsData(period)`
- `getPersonAnalyticsData(personId, period)`
- `getCurrentUserId()`

Задача интеграции:
- заменить мок на реальные API;
- оставить те же поля и ту же семантику;
- сохранить те же правила расчётов.

---

## Минимальные endpoint-ы для запуска
Рекомендуемый минимальный набор:
1. `GET /api/analytics?period=week|month|allTime`
2. `GET /api/analytics/person/{id}?period=week|month|allTime`
3. `GET /api/analytics/me` (или ваш аналог, который вернёт id текущего пользователя)

Если нужно сильнее декомпозировать API (kpi, графики, воронки по отдельности), это возможно, но потребует дополнительных изменений во фронте.

---

## Обязательные типы ответов

### `GET /api/analytics`
Возвращает `AnalyticsData`:
- `period`
- `periodLabel`
- `staticKpi`
- `dynamicKpi`
- `leadsTimeseries`
- `activityTimeseries`
- `funnels`
- `partners`
- `maxLeadsAdded`
- `maxStageChangesCount`

### `GET /api/analytics/person/{id}`
Возвращает `PersonAnalyticsData`:
- `period`
- `periodLabel`
- `person`
- `staticKpi`
- `dynamicKpi`
- `leadsTimeseries`
- `activityTimeseries`
- `funnels`
- `referrals`
- `maxLeadsAdded`
- `maxStageChangesCount`

Поведение при ошибках:
- если `id` не найден, возвращайте `404` или `null` (по вашему API-стандарту, но стабильно);
- `id` должен быть стабильным строковым идентификатором.

---

## Тайминги и периоды (самая важная часть)

### Поддерживаемые периоды
Тип периода: `AnalyticsPeriod = "week" | "month" | "allTime"`.

### Как именно считаются границы периода
Логика берётся из `getPeriodDateRange` в `lib/mock/analytics-network.ts`.

`week`:
- старт: понедельник текущей календарной недели;
- конец: воскресенье этой же недели, `23:59:59.999`.

`month`:
- старт: 1-е число текущего месяца;
- конец: последнее число текущего месяца, `23:59:59.999`.

`allTime`:
- старт: `2020-01-01`;
- конец: текущий день (`сейчас`), но для месячной агрегации график идёт помесячно.

### Важный нюанс по графикам
Для `week` и `month` графики строятся по дням.
Для `allTime` графики строятся по месяцам.

Из-за этого:
- неделя и месяц содержат также будущие дни текущего календарного периода;
- на будущие даты нужно отдавать валидные точки (обычно нули), чтобы не "ломать" ось графика.

### Таймзона
Нужна единая бизнес-таймзона на фронте и бэке. Иначе будут расхождения:
- в границах периода;
- в "онлайн сейчас";
- в `onlineDaysLast7`;
- в daily-графиках.

Рекомендация:
- зафиксировать одну таймзону (например, `Europe/Moscow`);
- считать все периоды и дневные срезы строго в ней.

---

## Словарь метрик простыми словами

### `StaticKpi`
- `level1Referrals`: сколько рефералов первого уровня у пользователя.
- `totalListings`: объектов всего (накопительно).
- `totalLeads`: лидов всего (накопительно).
- `totalDeals`: сделок всего (накопительно).

### `DynamicKpi` (за выбранный период)
- `addedListings`: добавлено объектов.
- `addedLevel1Referrals`: добавлено L1 рефералов.
- `addedLevel2Referrals`: добавлено L2 рефералов.
- `addedLeads`: добавлено лидов.
- `callClicks`: контакты через звонки.
- `chatOpens`: контакты через чаты.
- `selectionsCreated`: контакты через подборки.
- `deals`: сделки за период.

### Доп. метрики в таблицах партнёров (`PartnerRow`)
- `activityTotal = callClicks + chatOpens + selectionsCreated`
- `stageChangesCount`: количество изменений статусов лидов за период.
- `onlineDaysLast7`: онлайн-дни за календарную неделю Пн-Вс.
- `onlineWeekMarkers`: массив маркеров активности по дням недели.

---

## Критичные формулы и правила расчёта

### Правило расчёта `deals`
Сделки считаются через воронку `sales`:
- находим стадию `"Заключен договор"`;
- считаем кумулятивно эту стадию и все следующие в потоке.

Это реализовано через:
- `SALES_DEAL_STAGE_NAME = "Заключен договор"`
- `getDealsFromFunnels(...)`
- `getStageCumulativeCount(...)`

Если на бэке будет другое правило, цифры в карточках и воронке разъедутся.

### Правило маркера активности (`activityMarker`)
Логика:
- `green`: если `platformMinutes > 20` или `crmMinutes > 20`;
- `yellow`: если сумма минут `> 0`, но условия `green` не выполнены;
- `red`: если минут нет.

### Зона риска (в распределении активности)
В UI используется разная логика по периодам:
- `week`: зона риска = `onlineDaysLast7 === 0`
- `month` и `allTime`: зона риска = `activityMarker === "red"`

### Метрики блока "Эффективность за период"
Используются формулы:
- `totalTouches = callClicks + chatOpens + selectionsCreated`
- `leadToDeal = deals / addedLeads * 100`
- `touchToDeal = deals / totalTouches * 100`
- `contactsPerLead = totalTouches / addedLeads`

Граничные случаи:
- если деление на 0, UI ожидает `0`/`0.0` (без `NaN`, `Infinity`).

---

## Логика "онлайн" и почему там легко ошибиться

`isOnline`:
- не должен противоречить минутам активности и `lastSeenMinutesAgo`.

`lastSeenMinutesAgo`:
- если `isOnline = true`, ожидается `null`;
- если `isOnline = false`, ожидается число минут.

`onlineDaysLast7`:
- это не "последние 7*24 часа";
- это календарная неделя Пн-Вс, одинаковая сетка дней.

---

## Что должно быть консистентно между полями
- `activityTotal = callClicks + chatOpens + selectionsCreated`
- `maxLeadsAdded = max(partners[].leadsAdded)`
- `maxStageChangesCount = max(partners[].stageChangesCount)`
- в `referrals` нельзя включать самого текущего пользователя
- `periodLabel` должен соответствовать выбранному `period`

---

## План/факт: где хранится сейчас
Сейчас план/факт хранится локально на фронте:
- ключ: `analytics.personal.planTargets.v1`
- хранилище: `localStorage`
- влияет только на экран "Аналитика меня"

Если переносить на сервер:
1. `GET /api/analytics/me/plan-targets`
2. `PUT /api/analytics/me/plan-targets`

---

## Пошаговый план интеграции без боли
1. Поднимите `GET /api/analytics` с полным `AnalyticsData`.
2. Поднимите `GET /api/analytics/person/{id}` с полным `PersonAnalyticsData`.
3. Поднимите endpoint для `current user id` (экран `/analytics/me`).
4. Замените вызовы моков на `fetch`.
5. Сверьте формулы: `deals`, `activityTotal`, `max*`, `onlineDaysLast7`.
6. Сверьте периоды: границы недели/месяца и поведение будущих дат.
7. Пройдите ручной smoke по маршрутам:
   - `/analytics`
   - `/analytics/me`
   - `/analytics/partners/{id}`

---

## Быстрый чек-лист перед релизом
- все поля из `types/analytics.ts` приходят без `undefined`
- воронки приходят для `sales`, `network`, `owner`, `broker`
- графики не падают на пустых и нулевых данных
- карточка партнёра открывается по клику из таблиц/модалок
- в режиме партнёра недоступно редактирование плана
- в ответах нет логических конфликтов (`isOnline`, `lastSeenMinutesAgo`, минуты)

---

## Частые причины расхождений цифр
- бэк считает неделю "последние 7 дней", а UI ожидает календарную Пн-Вс
- разные таймзоны у сервера и клиента
- `deals` считается не от стадии `"Заключен договор"`
- в `week/month` не возвращаются точки на будущие даты периода
- `maxLeadsAdded` и `maxStageChangesCount` берутся не из тех же данных, что таблица

---

## Что должен знать человек в первый день
Если коротко:
- есть два главных контракта: `AnalyticsData` и `PersonAnalyticsData`;
- самые критичные места: периоды/таймзона и формула `deals`;
- если сохранить эти правила, фронт подключится к реальному API почти без визуальных доработок.
